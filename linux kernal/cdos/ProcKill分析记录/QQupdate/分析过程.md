# 1. 背景
兼容QQ针对qq8.9.1 版本，如果qqupdate，我们的wine可能不能兼容新版本QQ，所以我么需要让QQ禁止更新。
虽然QQ允许让用户设置禁止更新，但是作为兼容平台层，我们希望收回用户更新软件能力。
# 2. 设置文件权限
* 思路:首先我们git跟踪QQ更新文件前后变动,然后将替换文件的权限设置成不允许删除或者运行程序不能执行。
* 结果:设置成666,000,444,400等权限等级都失败
* 原因分析：跟新前后文件太多，我们不敢设置所有文件权限（可能会程序运行不了，也可能修改用户目录），，所以可能因为设置权限的文件不对。（但是，后来我设置了txupd.exe程序为444，发现更新程序任然可以执行）

# 3. 镜像回滚
* 思路： diff 更新前后文件变化，更新之后将文件回滚到旧版本
* 过程： 利用git工具手动回滚能达到禁止更新目的。但是什么时候打入切点，怎么打入切点存在问题。
    * update 前： git commit 保存切点
    * update 后： git checkout . & git clean -xdf 放弃所有文件修改
    * 重启QQ发现是旧版本。
    * 但是下面的问题，如果将打入切片的动作放在QQ生命周期中（最好是在点击update button时就打入切片）
## 3.1 跟踪update动作
这期间发现QQ针对太强了。
### 3.1.1 字符串跟踪
思路：更新按钮会有些字符串，比如“更新到最新版本”等提示，我想着能否根据字符串能找到程序入口
过程: QQ字符传基本上集中在一个字符串文件中，通过ID标识（猜测程序通过应用应用ID显示字符串），这种解耦方式增加寻找难度。后来发现更变态事情，找着找着发现有些字符串压根没出现，后来发现QQ直接应用的是图片，所以思路行不通。
原因：引用图片，不是引用字符串
查看更新前后记录
git status

# 通过git diff
手动git checkout 回退可以。
但是手动捕捉不到update动作

# 想通过字符串来找到标签入口，发现字符串基本上是图片，QQ是魔鬼


# 删除更新程序（有多个）
点击update时发现新创建的update进程，根据文件名称找到所有的更新程序
find . -name "txupd.exe"
然后删除就可以了

运行了一个晚上，还是被QQ检测出来了存在问题。

## 替换txupd.exe 程序
简单的替换了下txupd.exe程序。

可以检测到

# wine dbg 调试
* 运行后 attach调试失败
* 只能wine 启动调试

# 写一个探测程序
探测txupd.exe程序是否存在，如果出现立马杀死

* 探测程序占用资源：探测进程暂用内存6M，基本可以忽略
* 效果是，点击更新按钮没有反应

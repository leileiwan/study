[toc]

# 1. 背景
现在我们已经执行了进程0和进程1，本章重点介绍进程1创建进程2，进程2执行，最终shell进程开始执行，完成整个boot工作。

# 2. 打开终端文件和赋值文件句柄
* 用户使用键盘显示器通过shell进程和操作系统进行交互
tty0（终端文件）文件加载后形成如下效果图
![2019-08-19-15-22-37.png](./images/2019-08-19-15-22-37.png)

## 2.1 file_table[0]挂载在进程1的filp[0]中
* 加载问根文件系统后，在进程1支持下，通过调用open()函数来打开标准输入文件

![2019-08-19-15-35-17.png](./images/2019-08-19-15-35-17.png)
![2019-08-19-15-35-33.png](./images/2019-08-19-15-35-33.png)
![2019-08-19-15-36-46.png](./images/2019-08-19-15-36-46.png)

* open 函数执行后产生软中断，并最终映射到sys_open()函数执行。这个过程和第三章fork()映射到sys_fork()过程一致
![2019-08-19-15-42-52.png](./images/2019-08-19-15-42-52.png)

* sys_open首先将file_table[64]和filp[20]挂接
![2019-08-19-15-47-09.png](./images/2019-08-19-15-47-09.png)
![2019-08-19-15-48-42.png](./images/2019-08-19-15-48-42.png)
![2019-08-19-15-49-07.png](./images/2019-08-19-15-49-07.png)

### 2.1.1 确定绝对路径起点
* 内核调用open_namei()函数最终获取标准输入文件i节点
    * 首先通过dir_namei()获取/dev/tty0 的dev i节点
    * 通过dev i节点调用fine_entry()找到tty0这个目录项
    * 再通过该目录项找到tty0的i节点
![2019-08-19-16-04-23.png](./images/2019-08-19-16-04-23.png)

#### 2.1.1.1 下面调用dir_namei()函数

* dir_namei()首先调用get_dir()来获取枝梢i节点（dev），然后通过路径解析获取文件名tty0目录项地址和文件名长度信息。
![2019-08-19-16-12-56.png](./images/2019-08-19-16-12-56.png)
![2019-08-19-16-14-56.png](./images/2019-08-19-16-14-56.png)

    * get_fs_byte()是解析路径的核心函数，可以逐一提取路径中的字符，在后面经常使用到。
    ![2019-08-19-16-19-32.png](./images/2019-08-19-16-19-32.png)

    * get_dir()首先确定路径的绝对起点，即分析“/dev/tty0”这个路径的第一个字符是不是"/",如果是，则说明路径是绝对路径，因此将会从根节点开始查找路径。
    ![2019-08-19-16-45-08.png](./images/2019-08-19-16-45-08.png)
    ![2019-08-19-16-45-24.png](./images/2019-08-19-16-45-24.png)


* 获取dev目录i节点

从根路径i节点遍历解析"/dev/tyy0"这个路径名，首先会解析到dev这个目录项，之后在虚拟盘中找到这个目录所对应的逻辑块，并读进指定缓冲区。
![2019-08-19-17-00-52.png](./images/2019-08-19-17-00-52.png)
![2019-08-19-17-01-06.png](./images/2019-08-19-17-01-06.png)

/dev/ttyO 路径名 dev 的’d’字符开始遍历,遇到’/’后跳出循环, name I en 数值累加为 3 。这些信息将和根 i 节点指针一起,作为 find_entry()函数的参数使用。 find_entry()函数会将目录所在的逻辑块读入缓冲块。
![2019-08-19-17-03-20.png](./images/2019-08-19-17-03-20.png)

得到dev i节点号就可以“dev”目录所有应目录文件i节点，内核就可以通过i节点找到dev目录文件

* 获取i节点代码如下
![2019-08-19-17-07-33.png](./images/2019-08-19-17-07-33.png)
![2019-08-19-17-07-50.png](./images/2019-08-19-17-07-50.png)

inode_table[32 ]用来管理所有被打开文件的 i 节点; iget()函数根据 i 节点号和设备号,将文件 i 节点载入 inode_table[32 ]。获得 dev 目录文件 I 节点的情景如图 4-4 所示。
![2019-08-19-17-08-53.png](./images/2019-08-19-17-08-53.png)





[toc]
# 1.背景
前面我们已经知道启动了操作系统面函数。但是距离执行用户程序还有一段距离，比如用户程序进行计算、和设备交互、人机交互。
这章我们主要完成上面任务，初始化设备并且启动第一个进程--0号进程。

* 我们希望进程之间相互隔离，但是进程本身不具有这层“保护”，因此需要人为设计一层保护机制（进程管理信息数据结构）。进程管理数据结构包括task_struct、task[64]、GDT。
    * task-struct是每个进程独有。包含进程各项属性，时间片、进程执行状态、局部数据描述符表（LDT）、任务描述符表（TSS）
    * task[64]存储这系统中所有进程的task_struct
    * GDT 中存储这一套所有进程所有结构，通过索引项操作系统可以间接与每个进程中LDT和TSS建立关系。（TSS--任务描述符，LDT--私有描述符）

* 本章还讲解操作系统如何对内存、CPU、串行口、显示器、键盘、硬盘、软盘等硬件进行设计。并将这些硬件和中断服务关联。（对硬件可能不会很关注，这节内容可能会去掉很多）



# 2. 根设备、硬盘
* bootsect 初始化硬盘设备。细节我这边不是很关注。

# 3. 规划内存格局
* 处理内核代码和数据所占的内存外，将剩余内存设置缓存区，主内存，虚拟盘。
    * 主内存包含进行运行的空间，也包含内核管理进程的数据结构
    * 缓冲区是内存和外设数据交换的中转站
    * 虚拟盘（缓存）可以先将外设上的数据复制到虚拟盘中，提高读写速度。


## 3.1 设置虚拟盘大小
* 先根据内存大小对缓冲区和主内存打下进行设置，结果如下
![2019-08-13-16-39-16.png](./images/2019-08-13-16-39-16.png)
代码如下
![2019-08-13-17-23-18.png](./images/2019-08-13-17-23-18.png)

![2019-08-13-17-23-57.png](./images/2019-08-13-17-23-57.png)
![2019-08-13-17-24-25.png](./images/2019-08-13-17-24-25.png)
![2019-08-13-17-24-50.png](./images/2019-08-13-17-24-50.png)

* rd_init() 先将虚拟盘的请求处理函数do_rq_request()与图2-4函数控制结构blk_dev[7]第二项挂钩。将虚拟盘内内存区域清0.结果如下图所示。最后将虚拟盘长度返回，返回值用来设置主内存起始位置
    
    ![2019-08-13-17-35-43.png](./images/2019-08-13-17-35-43.png)

# 3.2. 设置主内存--内存管理结构mem_map初始化
* 对主内存起始位置确定，标志这主内存和缓冲区大小已经确定。这时调用men_init（）函数
* 系统使用mem_map对1M以上内存进行分页管理，记录一个页面使用次数。系统首先将所有页面置100，然后将主内存区域置0表示未使用。
* 操作系统内核区域（1M）和用户区域（主内存）使用的是不同的分页管理方。内核的分页管理方式使得线性地址和物理地址是一致的，但是用户区域的线性地址和用户地址不一致

初始化结果如下
![2019-08-14-09-06-58.png](./images/2019-08-14-09-06-58.png)

初始化代码如下
![2019-08-14-09-07-59.png](./images/2019-08-14-09-07-59.png)
![2019-08-14-09-08-23.png](./images/2019-08-14-09-08-23.png)


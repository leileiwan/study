QQ更新崩溃原因分析和修复
# 1. 问题描述
* 点击更新之后，有时候能正常阻止QQ更新，有时候Wine 会弹出异常的状态，异常描述如下
* 机器重启后的出现崩溃几率比较大，一段时间后很难再出现崩溃界面
# 1.1 核心代码如下
* 红色部分是修复后的代码
    * T 没有进行初始化，如果for循环没有处理，T是一个随机数，search返回值极有可能是1
    * 在获取文件路径时，没有使用debugstr_w()函数处理，参考第二章图片TRACE信息

![2019-10-16-18-52-17.png](./images/2019-10-16-18-52-17.png)
![2019-10-16-18-55-03.png](./images/2019-10-16-18-55-03.png)

# 2. 问题分析
* 没有经过debugstr_w()处理的sei_tmp.lpFile可能不是真正的路径，sei_tmp.lpFile可能是一个任意类型的值
* 如果sei_tmp.lpFile返回的是任意类型，那么search函数并没有发挥作用，虽然没有执行for循环，但是search return的极有可能是1
* 因此res_find>0通常会成立，从而执行return 0，恰巧不执行更新操作
## 2.1 为什么本地虚拟机上很难复现崩溃的场景?
通过上面得知，search 不执行for循环，也极有可能返回1，所以瞎猫撞死老鼠执行return 0阻止QQ更新操作
## 2.2 为什么重启的机器容易浮现崩溃场景，一段时间后不容易浮现
* 机器重启后，内存进行初始化，随机变量T的值敲是0，所以search 返回的是0，就不执行return操作，因此出现崩溃
* 一段时间后，内存开始有很多脏数据，随机变量T值非0，所以search返回1，执行return操作阻止QQ更新

# 3. 问题验证
## 3.1 复现崩溃的场景
* 将T用0初始化
* 结果，果然多次执行，每次都出现崩溃的界面。同时，return 0操作并没有被执行。

## 3.2 解决方法
* 首先打印sei_tmp.lpFile，输出的是一个字符，所以search for循环不会执行
* 然后打印debugstr_w(sei_tmp.lpFile)输出的是文件路径
* 传入serach的参数都经过debugstr_w()函数处理
* 结果，QQ不进行更新，return 0操作正常执行

以上可以验证猜想2是正确的